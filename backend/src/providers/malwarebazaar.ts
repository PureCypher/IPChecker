import type { ProviderResult } from '@ipintel/shared';
import { BaseProvider } from './base-provider.js';

/**
 * MalwareBazaar Provider (abuse.ch)
 * Database of malware samples and associated infrastructure
 * API: https://bazaar.abuse.ch/api/
 * Cost: Free
 */
export class MalwareBazaarProvider extends BaseProvider {
  protected async performLookup(
    ip: string,
    signal: AbortSignal
  ): Promise<Partial<ProviderResult>> {
    // MalwareBazaar doesn't have direct IP lookup, only hash lookup
    // We need to search through recent samples for IP references
    let samples: any[] = [];

    try {
      const recentResponse = await this.fetchWithTimeout(
        'https://mb-api.abuse.ch/api/v1/',
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `query=get_recent`,
          signal,
        },
        this.config.timeoutMs
      );

      if (!recentResponse.ok) {
        if (recentResponse.status === 401) {
          throw new Error('MalwareBazaar API requires authentication for this endpoint');
        }
        if (recentResponse.status === 429) {
          throw new Error('MalwareBazaar rate limit exceeded');
        }
        throw new Error(`MalwareBazaar returned ${recentResponse.status}: ${recentResponse.statusText}`);
      }

      const recentData = await recentResponse.json() as any;

      if (recentData?.query_status === 'ok' && recentData?.data) {
        // Filter samples that reference this IP in C2 destinations
        samples = recentData.data.filter((sample: any) => {
          // Check various fields that might contain IP addresses
          const destinations = sample.file_information?.cscb || [];
          const urls = sample.file_information?.urls || [];
          const ips = sample.file_information?.ips || [];

          return destinations.some((dest: string) => dest.includes(ip)) ||
                 urls.some((url: string) => url.includes(ip)) ||
                 ips.some((sampleIp: string) => sampleIp === ip);
        });
      } else if (recentData?.query_status === 'no_results') {
        // No recent samples found - this is normal
        samples = [];
      }
    } catch (error: any) {
      // If fetching recent samples fails, treat as no results instead of error
      if (error.message?.includes('authentication') || error.message?.includes('rate limit')) {
        throw error;
      }
      // Other errors - return no results gracefully
      samples = [];
    }

    const hasLinks = samples.length > 0;
    const malwareFamilies = [...new Set(samples.map((s: any) => s.file_information?.file_type))].filter(Boolean);

    return {
      abuseScore: hasLinks ? 95 : 0,
      raw: {
        linkedSamples: samples.length,
        malwareFamilies,
        recentActivity: hasLinks,
        samples: samples.slice(0, 5).map((s: any) => ({
          sha256: s.sha256_hash,
          fileType: s.file_information?.file_type,
          firstSeen: s.first_seen,
          signature: s.signature,
        })),
        note: hasLinks
          ? `IP linked to ${samples.length} malware sample(s) - ${malwareFamilies.join(', ')}`
          : 'No malware distribution links found',
      },
    };
  }
}
